# 一、简述

##### 1. 概念

MQTT是一种基于客户端和服务器的**发布和订阅**模式的“轻量级”通讯协议，构建于TCP/IP协议上。

##### 2. 优点

可以以极少的代码和有限的带宽，为连接远程设备提供实时可靠的消息服务， 低开销、低宽带占用的即时通讯协议，在物联网、小型设备、移动应用等方面有比较广泛的应用。

* 发布者与订阅者不比了解彼此，只要认识同一个消息代理即可。

- 发布者和订阅者不需要交互，发布者无需等待订阅者确认而导致锁定。
- 发布者和订阅者不需要同时在线，可以自由选择时间来消费消息。

# 二、特性

* 使用发布订阅模式，提供一对多的消息发布，解除应用程序耦合。

* 对负载内容屏蔽的消息传输。

* 使用TCP/IP提供网络连接。

* 有三种QoS消息发布服务质量

  * 级别0：尽力而为。消息发送者会想尽办法发送消息，但是遇到意外并不会重试。消息发布完全依赖底层TCP/IP网络。会发生消息丢失或重复。这一级别可用于如下情况，环境传感器数据，丢失一次读记录无所谓，因为不久后还会有第二次发送。这一种方式主要普通APP的推送，倘若你的智能设备在消息推送时未联网，推送过去没收到，再次联网也就收不到了。

  * 级别1：“至少一次”，确保消息到达，但消息重复可能会发生。

  * 级别2：“只有一次”，确保消息到达一次。在一些要求比较严格的计费系统中，可以使用此级别。在计费系统中，消息重复或丢失会导致不正确的结果。这种最高质量的消息发布服务还可以用于即时通讯类的APP的推送，确保用户收到且只会收到一次。

* 1字节固定报头，2字节心跳报文，最小化传输开销和协议交换，有效减少网络流量。

* 使用Last Will和Testament特性通知有关各方客户端异常中断的机制。

  * Last Will：即遗言机制，用于通知同一主题下的其他设备发送遗言的设备已经断开了连接。

  * Testament：遗嘱机制，功能类似于Last Will。

# 三、原理

##### 1. 实现方式

* 实现MQTT协议需要客户端和服务器端通讯完成，在通讯过程中，MQTT协议中有三种身份：发布者（Publish）、代理（Broker）（服务器）、订阅者（Subscribe）。

  其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。

* MQTT传输的消息分为：主题（Topic）和负载（payload）两部分：
  - （1）Topic，可以理解为消息的类型，订阅者订阅（Subscribe）后，就会收到该主题的消息内容（payload）；
  - （2）payload，可以理解为消息的内容，是指订阅者具体要使用的内容。

##### 2. 网络传输

MQTT会构建底层网络传输：它将建立客户端到服务器的连接，提供两者之间的一个有序的、无损的、基于字节流的双向传输。

当应用数据通过MQTT网络发送时，MQTT会把与之相关的服务质量（QoS）和主题名（Topic）相关连。

##### 3. 客户端与服务器

* **客户端**：使用MQTT协议的应用程序或者设备，它总是建立到服务器的网络连接。

  * 发布其他客户端可能会订阅的信息；

  * 订阅其它客户端发布的消息；

  * 退订或删除应用程序的消息；

  * 服务器连接。

* **服务端**：MQTT服务器以称为"消息代理"（Broker），可以是一个应用程序或一台设备。

  - 接受来自客户的网络连接；
  - 接受客户发布的应用信息；
  - 处理来自客户端的订阅和退订请求；
  - 向订阅的客户转发应用程序消息。

##### 4. 订阅、主题、会话

* 订阅（Subscription）

订阅包含主题筛选器（Topic Filter）和最大服务质量（QoS）。订阅会与一个会话（Session）关联。一个会话可以包含多个订阅。每一个会话中的每个订阅都有一个不同的主题筛选器。

* 会话（Session）

每个客户端与服务器建立连接后就是一个会话，客户端和服务器之间有状态交互。会话存在于一个网络之间，也可能在客户端和服务器之间跨越多个连续的网络连接。

* 主题名（Topic Name）

连接到一个应用程序消息的标签，该标签与服务器的订阅相匹配。服务器会将消息发送给订阅所匹配标签的每个客户端。

* 主题筛选器（Topic Filter）

一个对主题名通配符筛选器，在订阅表达式中使用，表示订阅所匹配到的多个主题。

* 负载（Payload）

消息订阅者所具体接收的内容。

##### 5. 方法

MQTT协议中定义了一些方法（也被称为动作），来于表示对确定资源所进行操作。这个资源可以代表预先存在的数据或动态生成数据，这取决于服务器的实现。通常来说，资源指服务器上的文件或输出。主要方法有：

- Connect

  等待与服务器建立连接。

- Disconnect

  等待MQTT客户端完成所做的工作，并与服务器断开TCP/IP会话。

- Subscribe

  等待完成订阅。

- UnSubscribe

  等待服务器取消客户端的一个或多个topics订阅。

- Publish

  MQTT客户端发送消息请求，发送完成后返回应用程序线程。

# 四、数据包结构

MQTT数据包结构如下：

- 固定头（Fixed header）。存在于所有MQTT数据包中，表示数据包类型及数据包的分组类标识。

  在不使用标识位的消息类型中，标识位被作为保留位。如果收到无效的标志时，接收端必须关闭网络连接：

  * DUP：发布消息的副本。用来在保证消息的可靠传输，如果设置为1，则在下面的变长中增加MessageId，并且需要回复确认，以保证消息传输完成，但不能用于检测消息重复发送。

  * QoS：发布消息的服务质量，即：保证消息传递的次数
  * RETAIN： 发布保留标识，表示服务器要保留这次推送的信息，如果有新的订阅者出现，就把这消息推送给它，如果设有那么推送至当前订阅者后释放。

- 可变头（Variable header）。存在于部分MQTT数据包中，数据包类型决定了可变头是否存在及其具体内容。

  * 可变头的内容因数据包类型而不同，较常的应用是作为包的标识：很多类型数据包中都包括一个2字节的数据包标识字段

- 消息体（Payload）。存在于部分MQTT数据包中，表示客户端收到的具体内容。

  Payload消息体位MQTT数据包的第三部分，包含CONNECT、SUBSCRIBE、SUBACK、UNSUBSCRIBE四种类型的消息：

  - CONNECT，消息体内容主要是：客户端的ClientID、订阅的Topic、Message以及用户名和密码。
  - SUBSCRIBE，消息体内容是一系列的要订阅的主题以及QoS。
  - SUBACK，消息体内容是服务器对于SUBSCRIBE所申请的主题及QoS进行确认和回复。
  - UNSUBSCRIBE，消息体内容是要订阅的主题。

